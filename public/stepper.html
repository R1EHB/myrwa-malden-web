<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stepper Example</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://dc-js.github.io/dc.js/css/dc.css">
  <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <style>
    div.dc-chart {
      float: none;
    }

    svg {
      font: 12px sans-serif;
    }

    .chart-title {
      font: 14px sans-serif;
    }

    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
      pointer-events: none;
      font: 14px sans-serif;
      z-index: 200;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      position: absolute;
      pointer-events: none;
    }

    /* Northward tooltips */
    .d3-tip.n:after {
      content: "\25BC";
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
      content: "\25C0";
      margin: -4px 0 0 0;
      top: 50%;
      left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
      content: "\25B2";
      margin: 0 0 1px 0;
      top: -8px;
      left: 0;
      text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
      content: "\25B6";
      margin: -4px 0 0 -1px;
      top: 50%;
      left: 100%;
    }

    .container {
      width: 980px;
    }

    .step-nav {
      width: 100%;
    }

    .stepper {
      position: relative;
      width: 980px;
      height: 500px;
      background-color: #fff;
      margin-top: 10px;
    }

    .annotation-container {
      position: absolute;
      width: 220px;
      height: 100%;
      background-color: #fff;
    }

    .annotation {
      position: absolute;
      display: none;
      left: 0;
      top: 10px;
      width: 210px;
    }

    .annotation > h2 {
      margin-top: 10px;
      font-size: 20px;
      padding-bottom: 5px;
      border-bottom: 1px solid #bbb;
    }

    .chart-container {
      position: absolute;
      width: 720px;
      height: 460px;
      top: 20px;
      left: 240px;
      z-index: 60;
    }

    #map {
      position: absolute;
      height: 460px;
      width: 720px;
      top: 0;
      left: 0;
    }

    #step1-chart {
      position: absolute;
      height: 300px;
      width: 720px;
      top: 10px;
      left: 0;
    }

    .loading {
      background: #eee;
      font-size: 36px;
      position: absolute;
      text-align: center;
      padding-top: 160px;
      top: 0;
      left: 0;
      z-index: 100;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Water Quality Conditions on the Malden River</h1>

  <hr>

  <div class="step-nav">
    <div class="btn-group" role="group" aria-label="Steps">
      <button type="button" class="btn btn-default btn-step" id="step1">1</a>
      <button type="button" class="btn btn-default btn-step" id="step2">2</a>
      <button type="button" class="btn btn-default btn-step" id="step3">3</a>
      <button type="button" class="btn btn-default disabled" id="step4">4</a>
      <button type="button" class="btn btn-default disabled" id="step5">5</a>
      <button type="button" class="btn btn-default disabled" id="step6">6</a>
      <button type="button" class="btn btn-default disabled" id="step7">7</a>
      <button type="button" class="btn btn-default disabled" id="step8">8</a>
      <button type="button" class="btn btn-default disabled" id="explore">Explore <i class="fa fa-angle-double-right" area-hidden="true"></i></a>
    </div>
  </div>

  <div class="stepper">
    <div class="annotation-container">
      <div class="annotation" id="step1-annotation" style="display:block">
        <h2>Sampling Location</h2>
        <p>Each month, MyRWA volunteers collect water quality samples throughout the Mystic River watershed as part of the <a href="http://mysticriver.org/baseline/" target="_blank">Baseline Water Quality Monitoring Program</a>.</p>
        <p>This map shows the monitoring station where samples are collected on the Malden River (Station ID: MAR036).</p>
        <div class="text-center" style="margin-top:20px">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default disabled"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Prev</a>
            <button type="button" class="btn btn-default" onclick="switchStep('step2')">Next <i class="fa fa-angle-double-right" aria-hidden="true"></i></a>
          </div>
        </div>
      </div>
      <div class="annotation" id="step2-annotation">
        <h2>E. coli Samples</h2>
        <p>Each sample is analyzed for E. coli, which is known as an indicator bacteria.</p>
        <p>The chart shows the E. coli levels of each sample over the past 14 years.</p>
        <p>But which samples are too high? How often is the river safe for boating?</p>
        <div class="text-center" style="margin-top:20px">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" onclick="switchStep('step1')"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Prev</a>
            <button type="button" class="btn btn-default" onclick="switchStep('step3')">Next <i class="fa fa-angle-double-right" aria-hidden="true"></i></a>
          </div>
        </div>
      </div>
      <div class="annotation" id="step3-annotation">
        <h2>Boating Standard</h2>
        <p>The horizontal line shows the Massachusetts water quality standard for E. coli, which states that no sample should exceed 1,260 #/100mL in waterways used for boating and other "secondary" recreational uses.</p>
        <p>Samples above the standard (in red) are called "exceedences" and indicate times when conditions were associated with an elevated risk of illness.</p>
        <p>Samples below the standard (in blue) indicate times when the risk of illness was low.</p>
        <div class="text-center" style="margin-top:20px">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" onclick="switchStep('step2')"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Prev</a>
            <button type="button" class="btn btn-default disabled">Next <i class="fa fa-angle-double-right" aria-hidden="true"></i></a>
          </div>
        </div>
      </div>
    </div>
    <div class="chart-container">
      <div id="chart-ts" style="display:none;"></div>
    </div>
    <div class="loading">
      <p>Loading...</p>
      <p><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i></p>
    </div>
  </div>

  <hr>
  <p>Developed by <a href="http://walkerenvres.com">Walker Environmental Research, LLC</a> for the <a href="http://mysticriver.org">Mystic River Watershed Association</a></p>
</div>

<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<script src="http://dc-js.github.io/dc.js/js/dc.js"></script>
<script src="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>

<script>
dc.constants.EVENT_DELAY = 0;

var state = {
    step: undefined,
    standard: {
      label: 'Boating Standard',
      value: 1260
    },
    weather: {
      precip48: 0.5
    },
    charts: {}
  },
  steps = {};

steps.step1 = {
  enter: function () {
    console.log('step1.enter()');
    d3.select('.chart-container').append('div').attr('id', 'map');
    this.map = L.map('map').setView([42.41, -71.072], 14);

    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(this.map);

    L.marker([42.4175, -71.073283]).addTo(this.map)
      .bindPopup('Station: <strong>MAR036</strong><br>Organization: <strong>Mystic River Watershed Association</strong>')
      .on('mouseover', function (e) {
        this.openPopup();
      })
      .on('mouseout', function (e) {
        this.closePopup();
      });
    // L.marker([42.4053, -71.07191]).addTo(this.map)
    //   .bindPopup('Station: <strong>MWRA176</strong><br>Organization: <strong>Massachusetts Water Resources Authority</strong>')
    //   .on('mouseover', function (e) {
    //     this.openPopup();
    //   })
    //   .on('mouseout', function (e) {
    //     this.closePopup();
    //   });
  },
  exit: function (done) {
    console.log('step1.exit()');
    this.map.remove();
    d3.select('#map').remove();
    done();
  }
};

steps.step2 = {
  enter: function () {
    // console.log('step2.enter()');
    if (!state.charts.ts) {
      // console.log('init: state.charts.ts');
      state.charts.ts = tsChart(d3.select('#chart-ts'));
    }

    state.charts.ts
      .colors(['#000'])
      .on('renderlet', function(chart) {
        var tip = state.charts.ts.tip();

        chart.select("svg").call(tip);

        chart.selectAll("path.symbol")
          .on('mouseover', tip.show)
          .on('mouseout', tip.hide);
      })
      .render();

    d3.select('#chart-ts').style('display', 'block').style('opacity', 1);
  },
  exit: function (done) {
    // console.log('step2.exit()');

    d3.select('#chart-ts')
      .style('opacity', 0)
      .style('display', 'none');

    done();

    // d3.select('#chart-ts')
    //   .transition()
    //   .delay(0)
    //   .duration(400)
    //   .style('opacity', 0)
    //   .each('end', function (d) {
    //     d3.select(this).style('display', 'none');
    //     done();
    //   });
  }
};

steps.step3 = {
  enter: function () {
    console.log('step3.enter()');

    if (!state.charts.ts) {
      // console.log('init: state.charts.ts');
      state.charts.ts = tsChart(d3.select('#chart-ts'));
    }

    state.charts.ts
      .colors(d3.scale.ordinal().domain(['Unsafe', 'Safe']).range(['#ff4500', '#00bfff']))
      .colorAccessor(function (d) {
        if (d) {
          return d.key[1] < state.standard.value ? 'Safe' : 'Unsafe';
        }
      })
      .on('renderlet', function(chart) {
        console.log('step3 chart-ts renderlet');
        var tip = state.charts.ts.tip();

        chart.select("svg").call(tip);

        chart.selectAll("path.symbol")
          .on('mouseover', tip.show)
          .on('mouseout', tip.hide);

        var extra_data = [
          {
            x: chart.x().range()[0],
            y: chart.y()(state.standard.value)
          }, {
            x: chart.x().range()[1],
            y: chart.y()(state.standard.value)
          }
        ];

        var line = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate('linear');

        var chartBody = chart.select('g.chart-body');

        var path = chartBody.selectAll('path.extra').data([extra_data]);
        path.enter().append('path').attr({
          class: 'extra',
          stroke: 'red',
          id: 'hline',
          'stroke-dasharray': '5,5'
        });
        path.attr('d', line);

        var text = chartBody.selectAll('text.hline-label').data([0]);

        text.enter()
          .append('text')
            .attr('text-anchor', 'end')
            .attr('class', 'hline-label')
            .attr('dy', '-0.5em');
        text.text('Boating Standard')
            .attr('x', chart.x().range()[1])
            .attr('y', chart.y()(state.standard.value));
      })
      .render();

    d3.select('#chart-ts').style('display', 'block').style('opacity', 1);
  },
  exit: function (done) {
    // console.log('step3.exit()');

    d3.select('#chart-ts')
      .style('opacity', 0)
      .style('display', 'none');

    done();

    // d3.select('#chart-ts')
    //   .transition()
    //   .delay(0)
    //   .duration(400)
    //   .style('opacity', 0)
    //   .each('end', function (d) {
    //     d3.select(this).style('display', 'none');
    //     done();
    //   });
  }
};

steps.step3 = {
  enter: function () {
    console.log('step3.enter()');

    if (!state.charts.ts) {
      // console.log('init: state.charts.ts');
      state.charts.ts = tsChart(d3.select('#chart-ts'));
    }

    state.charts.ts
      .colors(d3.scale.ordinal().domain(['Unsafe', 'Safe']).range(['#ff4500', '#00bfff']))
      .colorAccessor(function (d) {
        if (d) {
          return d.key[1] < state.standard.value ? 'Safe' : 'Unsafe';
        }
      })
      .on('renderlet', function(chart) {
        console.log('step3 chart-ts renderlet');
        var tip = state.charts.ts.tip();

        chart.select("svg").call(tip);

        chart.selectAll("path.symbol")
          .on('mouseover', tip.show)
          .on('mouseout', tip.hide);

        var extra_data = [
          {
            x: chart.x().range()[0],
            y: chart.y()(state.standard.value)
          }, {
            x: chart.x().range()[1],
            y: chart.y()(state.standard.value)
          }
        ];

        var line = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate('linear');

        var chartBody = chart.select('g.chart-body');

        var path = chartBody.selectAll('path.extra').data([extra_data]);
        path.enter().append('path').attr({
          class: 'extra',
          stroke: 'red',
          id: 'hline',
          'stroke-dasharray': '5,5'
        });
        path.attr('d', line);

        var text = chartBody.selectAll('text.hline-label').data([0]);

        text.enter()
          .append('text')
            .attr('text-anchor', 'end')
            .attr('class', 'hline-label')
            .attr('dy', '-0.5em');
        text.text('Boating Standard')
            .attr('x', chart.x().range()[1])
            .attr('y', chart.y()(state.standard.value));
      })
      .render();

    d3.select('#chart-ts').style('display', 'block').style('opacity', 1);
  },
  exit: function (done) {
    // console.log('step3.exit()');

    d3.select('#chart-ts')
      .style('opacity', 0)
      .style('display', 'none');

    done();

    // d3.select('#chart-ts')
    //   .transition()
    //   .delay(0)
    //   .duration(400)
    //   .style('opacity', 0)
    //   .each('end', function (d) {
    //     d3.select(this).style('display', 'none');
    //     done();
    //   });
  }
};

d3.selectAll('.btn-step').on('click', function () {
  var step = d3.select(this).attr('id');
  switchStep(step);
});

function switchStep (step) {
  d3.selectAll('.btn-step').classed('btn-primary', false).classed('btn-default', true);
  d3.select('#' + step).classed('btn-default', false);
  d3.select('#' + step).classed('btn-primary', true);
  switchAnnotation(step);

  if (state.step) {
    steps[state.step].exit(function () {
      state.step = step;
      steps[step].enter();
    });
  } else {
    state.step = step;
    steps[step].enter();
  }
}

function switchAnnotation (step) {
  d3.selectAll('.annotation').style('display', 'none');
  d3.select('#' + step + '-annotation').style('display', 'block');
}

function initialize () {
  var isoFormat = d3.time.format.utc("%Y-%m-%dT%H:%M:%SZ");

  d3.csv('data/wq.csv')
    .row(function (d) {
      return {
        site: d.site,
        param: d.param,
        datetime: isoFormat.parse(d.datetime),
        value: +d.value,
        precip: +d.precip,
        precip48: +d.precip48,
      }
    })
    .get(function (error, rows) {
      if (error) {
        console.log("Error: ", error);
        return;
      }

      // keep only ECOLI data collected through 2015 (exclude 2016 data)
      state.data = rows.filter(function (d) {
        return d.param === "ECOLI" && d.datetime.getFullYear() <= 2015;
      });

      state.data.forEach(function (d) {
        d.exceed = d.value > state.standard.value;
        d.month = d.datetime.getMonth();
      });

      state.ndx = crossfilter(state.data);
      state.all = state.ndx.groupAll();

      state.xf = {};

      state.xf.time = {};
      state.xf.time.dim = state.ndx.dimension(function (d) {
        return [d.datetime, d.value, d.site];
      });
      state.xf.time.group = state.xf.time.dim.group();


      state.xf.site = {};
      state.xf.site.dim = state.ndx.dimension(function (d) {
        return d.site;
      });
      state.xf.site.group = state.xf.site.dim.group();


      // remove loading frame
      d3.select('.loading')
        .transition()
        .delay(0)
        .duration(1000)
        .style('opacity', 0)
        .each("end", function (d) {
          d3.select(this).style('display', 'none');
        });

      switchStep('step1');
    });
}

initialize();

function setupCrossfilter () {
  // state.ndx = crossfilter(state.data);
  // state.all = state.ndx.groupAll();

  // state.xf = {};

  // state.xf.time = {};
  // state.xf.time.dim = state.ndx.dimension(function (d) {
  //   return [d.datetime, d.value, d.site];
  // });
  // state.xf.time.group = state.xf.time.dim.group();

  // state.xf.exceed = {};
  // state.xf.exceed.dim = state.ndx.dimension(function (d) {
  //   return d.value < state.params.standard ? "Safe" : "Unsafe";
  // });
  // state.xf.exceed.group = state.xf.exceed.dim.group();

  // state.xf.weather = {};
  // state.xf.weather.dim = state.ndx.dimension(function (d) {
  //   return d.precip48 >= state.params.precip48 ? "Wet" : "Dry";
  // });
  // state.xf.weather.group = state.xf.weather.dim.group();

  // state.xf.month = {};
  // state.xf.month.dim = state.ndx.dimension(function (d) {
  //   return months[d.month];
  // });
  // state.xf.month.group = state.xf.month.dim.group();

  // state.xf.precip = {};
  // state.xf.precip.dim = state.ndx.dimension(function (d) {
  //   return [d.precip48, d.value, d.site, d.datetime];
  // });
  // state.xf.precip.group = state.xf.precip.dim.group();
}

function tsChart(el) {
  var valueFormat = d3.format(",.0f");
  var datetimeFormat = d3.time.format("%x %X");

  var timeScale = d3.time.scale()
    .domain(d3.extent(state.data, function(d) { return d.datetime; }));
  var ecoliScale = d3.scale.log()
    .domain([1, d3.max(state.data, function(d) { return d.value; }) * 2]);

  var tip = d3.tip()
    .attr('class', 'd3-tip')
    .offset([-10, 0])
    .html(function(d) {
      return "<span>Station: </span> <strong>" + d.key[2] + "</strong><br>" +
             "<span>Datetime: </span> <strong>" + datetimeFormat(d.key[0]) + "</strong><br>" +
             "<span>E. coli: </span> <strong>" + valueFormat(d.key[1]) + " #/100mL</strong>";
    });

  var chart = dc.scatterPlot(el)
    .width(720)
    .height(250)
    .margins({top: 10, right: 50, bottom: 30, left: 50})
    .x(timeScale)
    .y(ecoliScale)
    .brushOn(false)
    .yAxisLabel('E. coli (#/100mL)')
    .xAxisLabel('Date')
    .clipPadding(10)
    .dimension(state.xf.time.dim)
    .group(state.xf.time.group)
    .excludedOpacity(0.5)
    .transitionDuration(200);

  // access tip function for customizing renderlet events
  chart.tip = function () {
    return tip;
  }

  var tickValues = [];
  [0, 1, 2, 3, 4, 5].forEach(function (exp) {
    [1, 2, 5].forEach(function (i) {
      tickValues.push(i*Math.pow(10, exp));
    });
  });
  chart.yAxis().tickFormat(function (d) {
    return tickValues.indexOf(d) >= 0 ? valueFormat(d) : "";
  });

  return chart;
}
</script>
</body>
</html>