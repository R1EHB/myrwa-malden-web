<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Malden River Water Quality</title>
  <link rel="stylesheet" href="http://dc-js.github.io/dc.js/css/dc.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" /> -->

  <style>
    div.dc-chart {
      float: none;
    }
  </style>
</head>
<body>
<h1>Water Quality Conditions on the Malden River</h1>

<hr>

<div>
  <div id="chart-time">
    <strong>Timeseries</strong>
    <span class="reset" style="display: none;"> <span class="filter"></span></span>
    <div class="clearfix"></div>
  </div>
  <div id="chart-exceed">
    <strong>% Exceedence</strong>
    <span class="reset" style="display: none;"> <span class="filter"></span></span>
    <div class="clearfix"></div>
  </div>
</div>

<hr>

<p>Developed by <a href="http://walkerenvres.com">Walker Environmental Research, LLC</a> for the <a href="http://mysticriver.org">Mystic River Watershed Association</a></p>

<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<script src="http://dc-js.github.io/dc.js/js/dc.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script> -->

<script>
var ndx;
var url_wq = '/data/wq.csv';
var isoParse = d3.time.format.utc("%Y-%m-%dT%H:%M:%SZ");
var state = {
  params: {
    limit: 235
  },
  xf: {},
  charts: {}
};

d3.csv(url_wq)
  .row(function (d) {
    return {
      site: d.site,
      param: d.param,
      datetime: isoParse.parse(d.datetime),
      value: +d.value,
      precip: +d.precip,
      precip48: +d.precip48
    }
  })
  .get(function (error, rows) {
    if (error) {
      console.log("Error: ", error);
      return;
    }

    state.data = rows.filter(function (d) {
      return d.param === "ECOLI";
    });

    setup(state);
  });

function setup (state) {
  dc.constants.EVENT_DELAY = 0;

  state.ndx = crossfilter(state.data);
  var all = state.ndx.groupAll();

  state.xf.scatter = {};
  state.xf.scatter.dim = state.ndx.dimension(function (d) {
    return [d.datetime, d.value];
  });
  state.xf.scatter.group = state.xf.scatter.dim.group();

  state.xf.exceed = {};
  state.xf.exceed.dim = state.ndx.dimension(function (d) {
    return d.value > state.params.limit;
  });
  state.xf.exceed.group = state.xf.exceed.dim.group();

  state.xf.time = {};
  state.xf.time.dim = state.ndx.dimension(function(d) { return d.datetime; }),
  state.xf.time.group = state.xf.time.dim.group();


  state.xf.line = {};
  state.xf.line.dim = state.ndx.dimension(function(d) { return d.datetime; }),
  state.xf.line.group = state.xf.line.dim.group().reduceSum(function (d) {
    return d.value;
  });

  var timeScale = d3.time.scale()
    .domain(d3.extent(state.data, function(d) { return d.datetime; }));
  var yScale = d3.scale.log()
    .domain([1, d3.max(state.data, function(d) { return d.value; })*2]);

  state.charts.scatter = dc.scatterPlot('#chart-time')
    .width(800)
    .height(280)
    .margins({top: 10, right: 50, bottom: 30, left: 50})
    .x(timeScale)
    .y(yScale)
    .brushOn(false)
    .yAxisLabel('E. coli')
    .xAxisLabel('Date')
    .clipPadding(10)
    .dimension(state.xf.scatter.dim)
    .excludedOpacity(0.5)
    .group(state.xf.scatter.group)
    .transitionDuration(10);

  // // Try using compose to force x-brush only
  // state.charts.scatter = dc.compositeChart('#chart-time');
  // state.charts.scatter
  //   .width(800)
  //   .height(280)
  //   .margins({top: 10, right: 50, bottom: 30, left: 50})
  //   .x(timeScale)
  //   .y(yScale)
  //   .yAxisLabel('E. coli')
  //   .xAxisLabel('Date')
  //   .clipPadding(10)
  //   .dimension(state.xf.scatter.dim)
  //   .legend(dc.legend().x(70).y(10).itemHeight(13).gap(5))
  //   .compose([
  //     dc.scatterPlot(state.charts.scatter)
  //       .group(state.xf.scatter.group, "E. coli")
  //       .transitionDuration(10),
  //     dc.lineChart(state.charts.scatter)
  //       .dimension(state.xf.time.dim)
  //       .group(state.xf.time.group)
  //       .transitionDuration(10)
  //   ]);

  state.charts.exceed = dc.pieChart('#chart-exceed')
    .width(200)
    .height(200)
    .radius(90)
    .dimension(state.xf.exceed.dim)
    .group(state.xf.exceed.group)
    .transitionDuration(10);

    // .transitionDuration(10)
    // .dimension(timeDim)
    // .group(timeGroup)

  dc.renderAll();
}

</script>

</body>
</html>